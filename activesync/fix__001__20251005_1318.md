# Fix 001 — 2025-10-05 13:18 UTC

## Symptom
- iOS Mail displayed “This message has not been downloaded from the server” when opening synced items.
- WBXML logs showed repeated fetch attempts without corresponding MIME payload delivery.

## Root Cause
- `ItemOperations` fetch responses omitted the required `ServerId`, `CollectionId`, and `Class` elements, so the client could not correlate the body payload.
- Single-item fetches defaulted to truncated HTML (BodyType 2) instead of full MIME data when no explicit `BodyPreference` was supplied.
- The server ignored granular `BodyPreference` requests because the `ItemOperations` WBXML fetch parser was a stub and always returned an empty list.

## Fix
- Implemented a minimal WBXML scanner (`_parse_itemops_fetches`) that extracts `Fetch` operations, their associated `CollectionId`, `ServerId`, and `BodyPreference` details so we respect the client request.
- Updated `_select_body_pref` to default single fetches to MIME (Type 4, no truncation) when the client does not specify a preference.
- Augmented `_build_itemops_wbxml_response` to emit `CollectionId`, `ServerId`, `Class`, `NativeBodyType`, and MIME payloads via OPAQUE blocks, ensuring the response conforms to Z-Push/grommunio behaviour and Apple’s expectations.

## Validation
- `python -m compileall app/routers/activesync.py activesync/wbxml_builder.py`
- Manually reviewed WBXML response structure to confirm `<Responses><Fetch>` now contains identifying fields and MIME bodies.

## Follow-up
- Extend WBXML parsing to support attachment fetches and multi-fetch requests (low priority for current scope).
