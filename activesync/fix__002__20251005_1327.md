# Fix 002 — 2025-10-05 13:27 UTC

## Symptom
- iOS client entered a rapid sync loop sending `SyncKey=0` and immediately receiving `Status=3 (InvalidSyncKey)`.
- Logs showed the server reporting `server_key=12` while returning an initial sync payload (`SyncKey 0→1`), causing every follow-up `SyncKey=1` to be rejected.

## Root Cause
- The handler only reset the persisted `SyncKey` state when the previous server key was `0` or empty.
- When a device legitimately restarted the conversation with `SyncKey=0` after the server had advanced, the stored key remained at `12`, so the next request triggered the large gap detector and forced another reset.

## Fix
- Always reset the server-side `ActiveSyncState` to `SyncKey=1` (and clear pagination/pending caches) whenever the client presents `SyncKey=0`, matching Z-Push and grommunio behaviour for restart scenarios.
- Added diagnostic logging that records the prior server key whenever a forced reset occurs so we can confirm the transition in future traces.

## Validation
- `python -m compileall app/routers/activesync.py`
- Reviewed new log path to ensure we now emit `sync_initial_reset_EARLY` with the previous key the first time the client requests a fresh sync.

## Follow-up
- Monitor device traces to confirm that the client advances to `SyncKey=1` and proceeds with normal incremental syncs without re-triggering the reset loop.
