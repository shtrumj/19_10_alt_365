{% extends "owa/base.html" %}

{% block title %}{{ email.subject }} - 365 Email System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ email.subject }}</h1>
    <div>
        <a href="/owa/inbox" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
        <button class="btn btn-danger" onclick="deleteEmail('{{ email.uuid if email.uuid else email.id }}')">
            <i class="fas fa-trash"></i> {{ get_translation(request, 'delete') }}
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="row">
            <div class="col-md-8">
                <div class="mb-2">
                    <strong>From:</strong> {{ email.sender.email if email.sender else email.external_sender }}
                </div>
                <div class="mb-2">
                    <strong>To:</strong> {{ email.recipient.email if email.recipient else email.external_recipient }}
                </div>
                <div class="mb-2">
                    <strong>Date:</strong> <span id="email-date" data-date="{{ email.created_at.isoformat() }}"></span>
                </div>
            </div>
            <div class="col-md-4 text-end">
                {% if not email.is_read %}
                    <span class="badge bg-primary">New</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="email-content">
            {% if email.parsed_content %}
                {{ email.parsed_content|safe }}
            {% elif email.body and ('<html' in email.body or '<div' in email.body or '<table' in email.body) %}
                {{ email.body|safe }}
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Unable to parse email content. Showing raw content:
                </div>
                <pre>{{ email.body[:500] }}{% if email.body|length > 500 %}...{% endif %}</pre>
            {% endif %}
        </div>
    </div>
</div>

<!-- Reply/Forward Options -->
<div class="card mt-3">
    <div class="card-body">
        <h5>Actions</h5>
        <div class="btn-group" role="group">
            <button class="btn btn-primary" onclick="replyEmail()">
                <i class="fas fa-reply"></i> Reply
            </button>
            <button class="btn btn-info" onclick="forwardEmail()">
                <i class="fas fa-share"></i> Forward
            </button>
            <button class="btn btn-warning" onclick="markAsUnread({{ email.id }})">
                <i class="fas fa-envelope"></i> Mark as Unread
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function deleteEmail(emailId) {
    console.log('Delete button clicked for email ID:', emailId);
    if (confirm('Are you sure you want to delete this email?')) {
        console.log('User confirmed deletion, sending DELETE request...');
        // Prefer OWA route which handles UUID and redirects
        window.location.href = '/owa/email/' + emailId + '/delete';
        return;
        .then(response => {
            console.log('Delete response status:', response.status);
            if (response.ok) {
                console.log('Email deleted successfully, redirecting to inbox...');
                window.location.href = '/owa/inbox';
            } else {
                console.error('Delete failed with status:', response.status);
                response.text().then(text => {
                    console.error('Delete error response:', text);
                    alert('Error deleting email: ' + text);
                });
            }
        })
        .catch(error => {
            console.error('Delete request failed:', error);
            alert('Error deleting email: ' + error.message);
        });
    } else {
        console.log('User cancelled deletion');
    }
}

function replyEmail() {
    const subject = 'Re: {{ email.subject }}';
    const fromEmail = '{{ email.sender.email if email.sender else email.external_sender }}';
    const body = '\n\n--- Original Message ---\nFrom: ' + fromEmail + '\nDate: {{ email.created_at.strftime('%Y-%m-%d %H:%M:%S') }}\nSubject: {{ email.subject }}\n\n{{ email.body }}';
    
    window.location.href = '/owa/compose?to=' + encodeURIComponent(fromEmail) + '&subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
}

function forwardEmail() {
    const subject = 'Fwd: {{ email.subject }}';
    const fromEmail = '{{ email.sender.email if email.sender else email.external_sender }}';
    const body = '\n\n--- Forwarded Message ---\nFrom: ' + fromEmail + '\nDate: {{ email.created_at.strftime('%Y-%m-%d %H:%M:%S') }}\nSubject: {{ email.subject }}\n\n{{ email.body }}';
    
    window.location.href = '/owa/compose?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
}

function markAsUnread(emailId) {
    // This would require a new API endpoint to mark as unread
    alert('Mark as unread functionality would be implemented here');
}

// Load URL parameters for reply/forward
document.addEventListener('DOMContentLoaded', function() {
    // Format date with +3h adjustment and timezone label
    try {
        const el = document.getElementById('email-date');
        if (el) {
            const iso = el.getAttribute('data-date');
            const d = new Date(iso);
            const adjusted = new Date(d.getTime() + 3 * 60 * 60 * 1000);
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const formatted = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            }).format(adjusted);
            const abbr = new Intl.DateTimeFormat('en-US', { timeZone: timezone, timeZoneName: 'short' })
              .formatToParts(adjusted).find(p => p.type === 'timeZoneName')?.value || '';
            el.textContent = formatted + ' ' + abbr;
        }
    } catch (e) { /* ignore */ }

    const urlParams = new URLSearchParams(window.location.search);
    const to = urlParams.get('to');
    const subject = urlParams.get('subject');
    const body = urlParams.get('body');
    
    if (to || subject || body) {
        // Redirect to compose with pre-filled data
        window.location.href = '/owa/compose?' + window.location.search;
    }
});
</script>
{% endblock %}
