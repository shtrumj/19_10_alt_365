{% extends "owa/base.html" %} {% block title %}Contacts - 365{% endblock %} {%
block content %}
<style>
  .contacts-surface {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .contacts-card {
    background: var(--color-surface-alt);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    box-shadow: 0 18px 36px rgba(29, 16, 44, 0.12);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .contacts-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 20px 42px rgba(29, 16, 44, 0.18);
  }

  .folder-tree {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    padding: 0.5rem 0;
  }

  .folder-node {
    padding: 0.55rem 0.75rem;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    color: var(--color-text-secondary);
    transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
  }

  .folder-node:hover {
    background: color-mix(in srgb, var(--primary-color) 16%, transparent 84%);
    color: var(--color-text-primary);
    transform: translateX(4px);
  }

  .folder-node.active {
    background: color-mix(in srgb, var(--primary-color) 24%, transparent 76%);
    color: var(--color-text-primary);
    border: 1px solid var(--primary-color);
  }

  .folder-children {
    margin-left: 1rem;
    border-left: 1px dashed var(--color-border);
    padding-left: 0.75rem;
  }

  .contact-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    justify-content: flex-end;
  }

  .table {
    color: var(--color-text-primary);
  }

  .table thead {
    background: color-mix(in srgb, var(--primary-color) 20%, transparent 80%);
    color: var(--color-text-primary);
  }

  .table tbody tr {
    cursor: pointer;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .table tbody tr:hover {
    background: color-mix(in srgb, var(--primary-color) 15%, transparent 85%);
    transform: translateX(2px);
  }

  .table tbody tr.active-row {
    background: color-mix(in srgb, var(--primary-color) 20%, transparent 80%);
    border-left: 3px solid var(--primary-color);
  }

  .table td,
  .table th {
    vertical-align: middle;
  }

  .contacts-empty {
    padding: 2.5rem 1rem;
    color: var(--color-text-secondary);
  }

  .modal-content {
    background: var(--color-surface-alt);
    border: 1px solid var(--color-border);
    border-radius: 18px;
    box-shadow: 0 24px 64px rgba(29, 16, 44, 0.28);
  }

  .modal-header,
  .modal-footer {
    border-color: var(--color-border);
  }

  .badge-chip {
    background: color-mix(in srgb, var(--primary-color) 18%, transparent 82%);
    color: var(--color-text-primary);
    border-radius: 999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
  }

  .contacts-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    color: var(--color-text-secondary);
    padding: 2rem 0;
  }

  .contacts-loading .spinner-border {
    width: 2rem;
    height: 2rem;
    border-width: 0.2rem;
  }

  [dir="rtl"] .modal-dialog,
  [dir="rtl"] .form-label,
  [dir="rtl"] .form-control,
  [dir="rtl"] .table,
  [dir="rtl"] .card-header,
  [dir="rtl"] .folder-tree {
    text-align: right;
  }

  [dir="rtl"] .content-header {
    flex-direction: row-reverse;
    gap: 1rem;
  }

  [dir="rtl"] .folder-node {
    padding-right: 1rem;
    padding-left: 0;
  }

  [dir="rtl"] .folder-node i {
    margin-left: 0;
    margin-right: 0.5rem;
  }

  @media (max-width: 991px) {
    #folderSidebar {
      display: none;
    }
  }
</style>
<div class="content-header d-flex justify-content-between align-items-center">
  <h1>{{ get_translation(request, 'contacts') }}</h1>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-secondary" onclick="toggleFolderSidebar()">
      <i class="fas fa-folder-tree"></i> {{ get_translation(request, 'folders')
      }}
    </button>
    <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#newContactModal"
      onclick="prepareNewContact()"
    >
      <i class="fas fa-user-plus"></i> {{ get_translation(request, 'add') }}
    </button>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-3" id="folderSidebar">
    <div class="contacts-card h-100">
      <div
        class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center"
      >
        <span class="fw-semibold text-uppercase small text-muted"
          >{{ get_translation(request, 'folders') }}</span
        >
        <button
          class="btn btn-sm btn-outline-primary"
          onclick="promptNewFolder()"
        >
          <i class="fas fa-folder-plus"></i>
        </button>
      </div>
      <div class="card-body folder-tree" id="folderTree"></div>
    </div>
  </div>
  <div class="col-lg-9">
    <div class="contacts-card">
      <div class="card-body">
        <div id="contactsLoading" class="contacts-loading d-none">
          <div
            class="spinner-border text-primary"
            role="status"
            aria-hidden="true"
          ></div>
          <span>{{ get_translation(request, 'loading') }}</span>
        </div>
        <div id="contactsTableWrapper" class="table-responsive">
          <table class="table table-hover align-middle" id="contactTable">
            <thead class="small text-uppercase">
              <tr>
                <th scope="col">{{ get_translation(request, 'name') }}</th>
                <th scope="col">Email</th>
                <th scope="col">{{ get_translation(request, 'phone') }}</th>
                <th scope="col">{{ get_translation(request, 'company') }}</th>
                <th scope="col">{{ get_translation(request, 'title') }}</th>
              </tr>
            </thead>
            <tbody>
              {% if contacts %} {% for c in contacts %}
              <tr data-contact="{{ c.uuid }}">
                <td>{{ c.display_name }}</td>
                <td>{{ c.email_address_1 }}</td>
                <td>{{ c.mobile_phone or c.business_phone }}</td>
                <td>{{ c.company_name }}</td>
                <td>{{ c.job_title }}</td>
              </tr>
              {% endfor %} {% else %}
              <tr class="text-muted contacts-empty">
                <td colspan="5" class="text-center">
                  {{ get_translation(request, 'no_contacts') }}
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="newContactModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ get_translation(request, 'add_contact') }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="contactForm" class="row g-3">
          <input
            type="hidden"
            name="folder_uuid"
            id="contactFolderField"
            value="{{ active_folder_uuid }}"
          />
          <input type="hidden" name="uuid" id="contactUuidField" />

          <div class="col-md-6">
            <label class="form-label"
              >{{ get_translation(request, 'name') }}</label
            >
            <input class="form-control" name="display_name" />
          </div>
          <div class="col-md-3">
            <label class="form-label"
              >{{ get_translation(request, 'first_name') }}</label
            >
            <input class="form-control" name="given_name" />
          </div>
          <div class="col-md-3">
            <label class="form-label"
              >{{ get_translation(request, 'last_name') }}</label
            >
            <input class="form-control" name="surname" />
          </div>

          <div class="col-md-4">
            <label class="form-label"
              >{{ get_translation(request, 'email_1') }}</label
            >
            <input class="form-control" name="email_address_1" />
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >{{ get_translation(request, 'email_2') }}</label
            >
            <input class="form-control" name="email_address_2" />
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >{{ get_translation(request, 'email_3') }}</label
            >
            <input class="form-control" name="email_address_3" />
          </div>

          <div class="col-md-4">
            <label class="form-label"
              >{{ get_translation(request, 'mobile') }}</label
            >
            <input class="form-control" name="mobile_phone" />
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >{{ get_translation(request, 'phone') }} (Business)</label
            >
            <input class="form-control" name="business_phone" />
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >{{ get_translation(request, 'phone') }} (Home)</label
            >
            <input class="form-control" name="home_phone" />
          </div>

          <div class="col-md-4">
            <label class="form-label"
              >{{ get_translation(request, 'company') }}</label
            >
            <input class="form-control" name="company_name" />
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >{{ get_translation(request, 'department') }}</label
            >
            <input class="form-control" name="department" />
          </div>
          <div class="col-md-4">
            <label class="form-label"
              >{{ get_translation(request, 'title') }}</label
            >
            <input class="form-control" name="job_title" />
          </div>

          <div class="col-md-6">
            <label class="form-label"
              >{{ get_translation(request, 'business_address') }}</label
            >
            <textarea
              class="form-control"
              name="business_address_street"
              rows="2"
            ></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label"
              >{{ get_translation(request, 'home_address') }}</label
            >
            <textarea
              class="form-control"
              name="home_address_street"
              rows="2"
            ></textarea>
          </div>

          <div class="col-md-12">
            <label class="form-label"
              >{{ get_translation(request, 'notes') }}</label
            >
            <textarea class="form-control" name="notes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          class="btn btn-outline-danger me-auto d-none"
          id="deleteContactBtn"
          type="button"
          onclick="deleteContact()"
        >
          <i class="fas fa-trash"></i>
          {{ get_translation(request, 'delete') }}
        </button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">
          {{ get_translation(request, 'cancel') }}
        </button>
        <button class="btn btn-primary" type="button" onclick="saveContact()">
          {{ get_translation(request, 'save') }}
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let activeFolderUuid = "{{ active_folder_uuid or '' }}";

  function toggleFolderSidebar() {
    document.getElementById("folderSidebar").classList.toggle("d-none");
  }

  function renderFolderTree(nodes, container, level = 0) {
    container.innerHTML = "";
    nodes.forEach((node) => {
      const item = document.createElement("div");
      item.className =
        `folder-node level-${level}` +
        (node.uuid === activeFolderUuid ? " active" : "");
      item.dataset.uuid = node.uuid;
      item.innerHTML = `<i class="fas fa-folder"></i> <span>${node.display_name}</span>`;
      item.addEventListener("click", () => selectFolder(node.uuid));
      container.appendChild(item);
      if (node.children && node.children.length) {
        const childContainer = document.createElement("div");
        childContainer.className = "folder-children";
        container.appendChild(childContainer);
        renderFolderTree(node.children, childContainer, level + 1);
      }
    });
  }

  async function loadFolders() {
    const res = await fetch("/contacts/folders", { credentials: "include" });
    if (!res.ok) return;
    const tree = await res.json();
    renderFolderTree(tree, document.getElementById("folderTree"));
  }

  async function selectFolder(uuid) {
    activeFolderUuid = uuid;
    document.getElementById("contactFolderField").value = uuid;
    await loadContacts(uuid);
    await loadFolders();
  }

  async function loadContacts(folderUuid) {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (folderUuid) params.append("folder_uuid", folderUuid);
      const res = await fetch(`/contacts/list?${params}`, {
        credentials: "include",
      });
      if (!res.ok) return;
      const contacts = await res.json();
      const tbody = document.querySelector("#contactTable tbody");
      tbody.innerHTML = "";
      if (!contacts.length) {
        const row = document.createElement("tr");
        row.className = "text-muted";
        row.innerHTML = `<td colspan="5" class="text-center">${"{{ get_translation(request, 'no_contacts') }}"}</td>`;
        tbody.appendChild(row);
        return;
      }
      contacts.forEach((c) => {
        const row = document.createElement("tr");
        row.dataset.contact = c.uuid;
        row.innerHTML = `
        <td>${c.display_name || ""}</td>
        <td>${c.email_address_1 || ""}</td>
        <td>${c.mobile_phone || c.business_phone || ""}</td>
        <td>${c.company_name || ""}</td>
        <td>${c.job_title || ""}</td>`;
        row.addEventListener("click", () => openContact(c.uuid));
        tbody.appendChild(row);
      });
    } finally {
      setLoading(false);
    }
  }

  async function promptNewFolder() {
    const name = prompt(
      "{{ get_translation(request, 'folder_name_prompt') or 'Folder name' }}",
    );
    if (!name) return;
    const body = { display_name: name };
    if (activeFolderUuid) {
      body.parent_uuid = activeFolderUuid;
    }
    const res = await fetch("/contacts/folders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(body),
    });
    if (res.ok) {
      await loadFolders();
    } else {
      alert("Failed to create folder");
    }
  }

  async function saveContact() {
    const form = document.getElementById("contactForm");
    const data = new FormData(form);
    const payload = Object.fromEntries(data.entries());
    Object.keys(payload).forEach((key) => {
      if (payload[key] === "" || payload[key] === null || payload[key] === undefined) {
        delete payload[key];
      }
    });
    if (!payload.folder_uuid && activeFolderUuid) {
      payload.folder_uuid = activeFolderUuid;
    }
    delete payload.uuid;
    const contactUuid = document.getElementById("contactUuidField").value;
    const contactUuid = document.getElementById("contactUuidField").value;
    const url = contactUuid ? `/contacts/${contactUuid}` : "/contacts/create";
    const method = contactUuid ? "PUT" : "POST";
    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
      credentials: "include",
    });
    if (res.ok) {
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("newContactModal"),
      );
      modal.hide();
      resetContactForm();
      if (activeFolderUuid) {
        document.getElementById("contactFolderField").value = activeFolderUuid;
      }
      await loadContacts(activeFolderUuid);
    } else {
      alert("Failed to save contact");
    }
  }

  async function openContact(uuid) {
    const rows = document.querySelectorAll("#contactTable tbody tr");
    rows.forEach((r) => r.classList.toggle("active-row", r.dataset.contact === uuid));
    const res = await fetch(`/contacts/${uuid}`, { credentials: "include" });
    if (!res.ok) return;
    const contact = await res.json();
    populateContactForm(contact);
    const modal = new bootstrap.Modal(
      document.getElementById("newContactModal"),
    );
    modal.show();
  }

  function populateContactForm(contact) {
    const form = document.getElementById("contactForm");
    Object.entries(contact).forEach(([key, value]) => {
      const field = form.elements.namedItem(key);
      if (field) {
        field.value = value ?? "";
      }
    });
    document.getElementById("contactUuidField").value = contact.uuid;
    document.getElementById("contactFolderField").value =
      contact.folder_uuid || activeFolderUuid || "";
    document
      .getElementById("deleteContactBtn")
      .classList.remove("d-none");
  }

  function resetContactForm() {
    const form = document.getElementById("contactForm");
    form.reset();
    document.getElementById("contactUuidField").value = "";
    document
      .getElementById("deleteContactBtn")
      .classList.add("d-none");
    if (activeFolderUuid) {
      document.getElementById("contactFolderField").value = activeFolderUuid;
    }
  }

  async function deleteContact() {
    const contactUuid = document.getElementById("contactUuidField").value;
    if (!contactUuid) return;
    if (
      !confirm(
        "{{ get_translation(request, 'delete_confirm') or 'Delete this contact?' }}",
      )
    ) {
      return;
    }
    const res = await fetch(`/contacts/${contactUuid}`, {
      method: "DELETE",
      credentials: "include",
    });
    if (res.ok) {
      const modal = bootstrap.Modal.getInstance(
        document.getElementById("newContactModal"),
      );
      modal.hide();
      resetContactForm();
      await loadContacts(activeFolderUuid);
    } else {
      alert("Failed to delete contact");
    }
  }

  function setLoading(isLoading) {
    document
      .getElementById("contactsLoading")
      .classList.toggle("d-none", !isLoading);
    document
      .getElementById("contactsTableWrapper")
      .classList.toggle("d-none", isLoading);
  }

  function prepareNewContact() {
    resetContactForm();
    const rows = document.querySelectorAll("#contactTable tbody tr");
    rows.forEach((r) => r.classList.remove("active-row"));
  }

  document
    .getElementById("newContactModal")
    .addEventListener("hidden.bs.modal", resetContactForm);

  document.addEventListener("DOMContentLoaded", async () => {
    await loadFolders();
    if (activeFolderUuid) {
      await loadContacts(activeFolderUuid);
    }
  });
</script>
{% endblock %}
