{% extends "owa/base.html" %}

{% block title %}ניטור תעבורה - {{ get_translation(request, 'app_name') }}{% endblock %}

{% block content %}
<div class="content-header">
  <h1><i class="fas fa-search"></i> ניטור תעבורה</h1>
  <div></div>
</div>

<div class="alert alert-info">חיפוש הודעות שהתקבלו (קצה ראשון) לפי שולח, נמען וחלון זמן.</div>

<div class="row">
  <div class="col-md-12">
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-filter text-primary"></i> מסננים</h5>
        <div></div>
      </div>
      <div class="card-body">
        <form id="audit-form" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">שולח</label>
            <input type="text" class="form-control" id="filter-sender" placeholder="name@example.com">
          </div>
          <div class="col-md-4">
            <label class="form-label">נמען</label>
            <input type="text" class="form-control" id="filter-recipient" placeholder="user@domain.com">
          </div>
          <div class="col-md-2">
            <label class="form-label">חלון זמן</label>
            <select class="form-select" id="filter-window">
              <option value="5m">5 דקות</option>
              <option value="15m">15 דקות</option>
              <option value="1h" selected>שעה</option>
              <option value="6h">6 שעות</option>
              <option value="24h">24 שעות</option>
              <option value="7d">7 ימים</option>
              <option value="30d">30 ימים</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <div class="d-grid gap-2 w-100">
              <button type="button" class="btn btn-primary" onclick="runAudit()"><i class="fas fa-search"></i> חפש</button>
              <button type="button" class="btn btn-outline-secondary" onclick="toggleAutoRefresh()" id="auto-btn"><i class="fas fa-sync"></i> רענון אוטומטי: כבוי</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-inbox text-primary"></i> תוצאות</h5>
        <small class="text-muted" id="result-meta"></small>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>זמן</th>
                <th>שולח</th>
                <th>נמען</th>
                <th>נושא</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="results-body">
              <tr><td colspan="6" class="text-center text-muted">אין נתונים</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mt-3">
  <div class="col-md-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-terminal text-primary"></i> SMTP Logs (Live)</h5>
        <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">רענן</button>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <h6>internal_smtp.log</h6>
          <pre id="log-internal" style="white-space: pre-wrap; background:#111; color:#0f0; padding:10px; border-radius:8px; max-height:300px; overflow:auto"></pre>
        </div>
        <div class="mb-3">
          <h6>smtp_errors.log</h6>
          <pre id="log-errors" style="white-space: pre-wrap; background:#111; color:#f33; padding:10px; border-radius:8px; max-height:200px; overflow:auto"></pre>
        </div>
        <div>
          <h6>email_processing.log</h6>
          <pre id="log-processing" style="white-space: pre-wrap; background:#111; color:#0ff; padding:10px; border-radius:8px; max-height:200px; overflow:auto"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let autoTimer = null;

function toggleAutoRefresh(){
  if(autoTimer){
    clearInterval(autoTimer);
    autoTimer = null;
    document.getElementById('auto-btn').textContent = 'רענון אוטומטי: כבוי';
    document.getElementById('auto-btn').classList.remove('btn-success');
    document.getElementById('auto-btn').classList.add('btn-outline-secondary');
  } else {
    runAudit();
    autoTimer = setInterval(runAudit, 5000);
    document.getElementById('auto-btn').textContent = 'רענון אוטומטי: פועל';
    document.getElementById('auto-btn').classList.remove('btn-outline-secondary');
    document.getElementById('auto-btn').classList.add('btn-success');
  }
}

async function runAudit(){
  const sender = document.getElementById('filter-sender').value.trim();
  const recipient = document.getElementById('filter-recipient').value.trim();
  const windowVal = document.getElementById('filter-window').value;
  const params = new URLSearchParams();
  if(sender) params.set('sender', sender);
  if(recipient) params.set('recipient', recipient);
  params.set('window', windowVal);
  params.set('limit', '200');
  const url = `/owa/admin/audit/emails?${params.toString()}`;
  try{
    const res = await fetch(url);
    if(!res.ok){ return; }
    const data = await res.json();
    renderResults(data);
  }catch(e){ console.error(e); }
}

function renderResults(data){
  const tbody = document.getElementById('results-body');
  tbody.innerHTML = '';
  document.getElementById('result-meta').textContent = `נמצאו ${data.count} | מאז ${new Date(data.since).toLocaleString()}`;
  if(!data.items || data.items.length === 0){
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">אין נתונים</td></tr>';
    return;
  }
  data.items.forEach((item, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td><span class="badge bg-light text-dark">${new Date(item.created_at).toLocaleString()}</span></td>
      <td>${item.sender_email || ''}</td>
      <td>${item.recipient_email || ''}</td>
      <td>${escapeHtml(item.subject || '')}</td>
      <td><a class="btn btn-sm btn-outline-primary" href="/owa/email/${item.id}?lang={{ get_language(request) }}" target="_blank"><i class="fas fa-external-link-alt"></i></a></td>
    `;
    tbody.appendChild(tr);
  });
}

function escapeHtml(str){
  return str.replace(/[&<>"]+/g, function(c){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]);
  });
}

async function refreshLogs(){
  try{
    const res = await fetch('/owa/admin/audit/logs');
    if(!res.ok) return;
    const data = await res.json();
    document.getElementById('log-internal').textContent = data.internal_smtp || '';
    document.getElementById('log-errors').textContent = data.smtp_errors || '';
    document.getElementById('log-processing').textContent = data.email_processing || '';
  }catch(e){ console.error(e); }
}
document.addEventListener('DOMContentLoaded', function(){
  runAudit();
  refreshLogs();
  setInterval(refreshLogs, 5000);
});
</script>
{% endblock %}



